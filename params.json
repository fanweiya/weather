{
  "name": "Weather",
  "tagline": "chrome extensions",
  "body": "## 极简天气\r\n一款简单的chrome天气插件。\r\n\r\n如图：\r\n\r\n![截图https://github.com/yohnz/weather/raw/master/images/1.png \"截图\")\r\n\r\n戳这里右键另存为：<https://github.com/yohnz/weather/weather.crx>\r\n\r\n\r\n### 创建文件\r\n新建weather文件夹，里面包含manifest.json，popup.html和images文件夹。images文件夹放16,48,128三种不同尺寸的图标\r\n\r\nmanifest.json内代码如下：\r\n```\r\n{\r\n  \"manifest_version\":2,\r\n  \"name\":\"极简天气\",\r\n  \"description\":\"极简天气预报\",\r\n  \"version\":\"1.0\",\r\n  \"icons\": {\r\n        \"16\": \"images/sun16.png\",\r\n        \"48\": \"images/sun48.png\",\r\n        \"128\": \"images/sun128.png\"\r\n   },\r\n  \"browser_action\":{\r\n      \"default_icon\":\"images/sun48.png\",\r\n      \"default_title\":\"天气预报\",\r\n      \"default_popup\":\"popup.html\"\r\n  },\r\n   \r\n}\r\n```\r\n\r\npopup.html的代码如下：\r\n```\r\n<!DOCTYPE html>\r\n<html lang=\"zh\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <title>天气</title>\r\n</head>\r\n<body>\r\n <div class=\"weather\">    \r\n    Test    \r\n </div>\r\n</body>\r\n</html>\r\n```\r\n### 文件说明\r\n\r\n**manifest.json**\r\n\r\n必需文件，是整个扩展的入口，每个Chrome扩展都包含一个Manifest文件。Manifest必须包含name、version和manifest_version属性。\r\n\r\n属性说明：\r\n\r\n- `manifest_version`指定文件格式的版本，在Chrome18之后，应该都是2\r\n- `name`扩展名称\r\n- `version` 扩展版本号\r\n- `version`扩展的版本\r\n- `icons`扩展列表图标\r\n- `browser_action`指定扩展在Chrome工具栏中的显示信息。\r\n- `default_icon`、`default_title`、`default_popup`依次指定图标、标题、对应的页面\r\n\r\n**Popup页面**\r\n\r\nPopup页面是当用户点击扩展图标时，展示在图标下面的页面。\r\n\r\n打开chrome扩展程序界面，勾选\"开发者模式\",拖入weather文件夹，然后就可以看到weather扩展已经出现在chrome扩展程序列表了\r\n\r\n![](https://github.com/yohnz/weather/raw/master/images/1.jpg)\r\n\r\n同时，工具栏也出现了weather的图标，点击之后会弹出popup界面:\r\n\r\n![](https://github.com/yohnz/weather/raw/master/images/2.jpg)\r\n\r\n\r\n### 完善页面和样式\r\n完善静态popup页面,模拟天气数据:\r\n```\r\n<!DOCTYPE html>\r\n<html lang=\"zh\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <title>天气</title>\r\n</head>\r\n<body>\r\n    <div class=\"weather\">\r\n        <div class=\"today\" id=\"today\">\r\n            <h1 class=\"city\">厦门</h1>\r\n            <div class=\"row_detail\"><img src=\"http://files.heweather.com/cond_icon/104.png\">\r\n                <h1>19<span>℃</span></h1></div>\r\n            <div class=\"wind\">\r\n                <h2>阴</h2>\r\n                <h4>风速 20   湿度 89%</h4></div>\r\n        </div>\r\n        <div class=\"content\">\r\n            <div class=\"wrap\" id=\"wrap\">\r\n                <div class=\"row\">\r\n                    <h4>2016-05-16</h4><img src=\"http://files.heweather.com/cond_icon/104.png\">\r\n                    <h1>19~24</h1>\r\n                    <h4>阴</h4>\r\n                </div>               \r\n            </div>\r\n        </div>\r\n    </div>\r\n</body>\r\n</html>\r\n```\r\n\r\n新建CSS文件，并在popup页面引入\r\n```\r\nbody{\r\n    width:740px;\r\n    height:400px;\r\n    font-family: 'Microsoft Yahei';\r\n    color:#333;\r\n    background:#fefefe;\r\n    text-shadow:1px 1px 6px #333;\r\n}\r\n\r\n.city{\r\n    text-align:center\r\n}\r\n.today{\r\n    padding-bottom:30px;\r\n}\r\n.row_detail{\r\n    display: flex;\r\n    direction: row;\r\n    justify-content:center;\r\n    align-items: center;\r\n}\r\n.row_detail img{\r\n    width:80px;    \r\n}\r\n.row_detail h1{\r\n    font-size:60px;\r\n}\r\n.wind{\r\n    text-align: center;\r\n}\r\n.content{\r\n    display: flex;\r\n    direction: column\r\n}\r\n\r\n.wrap{\r\n    display: flex;\r\n    direction: row;\r\n    flex: 1;\r\n    justify-content:space-around;\r\n    align-items: center;\r\n}\r\n.row{\r\n    background:#fff;\r\n    border:1px solid #ccc;\r\n    padding:10px;\r\n    box-shadow: 0 2px 10px rgba(0,0,0,.3);\r\n}\r\n.row img{\r\n    width:80px;\r\n}\r\n.row h1{\r\n    font-size:18px;\r\n}\r\nh1,h4{\r\n    text-align: center;\r\n    margin:0;\r\n}\r\n\r\n```\r\n点击工具栏weather图标，此时界面如图：\r\n\r\n![](https://github.com/yohnz/weather/raw/master/images/3.jpg)\r\n\r\n### 获取真实天气数据\r\nGoogle允许Chrome扩展应用不必受限于跨域限制。但出于安全考虑，需要在Manifest的permissions属性中声明需要跨域的权限。\r\n这里以[和风天气API](http://www.heweather.com/)为例.\r\n首先，在Manifest里添加要请求的API接口：\r\n```\r\n\"permissions\":[\r\n     \"http://api.openweathermap.org/data/2.5/forecast?q=*\",   \r\n  ]\r\n```\r\n然后新建popup.js并在popup页面中引入\r\n简单的ajax函数：\r\n```\r\nfunction httpRequest(url,callback) {\r\n    var xhr = new XMLHttpRequest();\r\n    xhr.open('GET',url,true);\r\n    xhr.onreadystatechange = function() {\r\n        if(xhr.readyState === 4){\r\n            callback(xhr.responseText);\r\n        }\r\n    }\r\n    xhr.send();\r\n}\r\n```\r\n和风天气API可以通过城市名称，城市代码,IP三种方式来获取指定城市天气数据，不过经过测试发现，IP获取的方式不准确，城市有偏差，所以，直接用城市名称来获取。这里借用`http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=json`获取城市名称。\r\n```\r\nhttpRequest('http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=json',function(data) {\r\n    if(!data) return;\r\n    data = JSON.parse(data);\r\n    var city = data.city;\r\n    var url = 'https://api.heweather.com/x3/weather?city='+city+'&key=youkey';\r\n        httpRequest(url,function(data) {\r\n            data = JSON.parse(data);\r\n            var result = data[\"HeWeather data service 3.0\"][0];        \r\n            showWeather(city,result);            \r\n        });\r\n});\r\n```\r\n为了方便的解析图片，构建一个json\r\n```\r\nvar cond_info = {\r\n100:\"http://files.heweather.com/cond_icon/100.png\",\r\n101:\"http://files.heweather.com/cond_icon/101.png\",\r\n102:\"http://files.heweather.com/cond_icon/102.png\",\r\n103:\"http://files.heweather.com/cond_icon/103.png\",\r\n104:\"http://files.heweather.com/cond_icon/104.png\",\r\n200:\"http://files.heweather.com/cond_icon/200.png\",\r\n201:\"http://files.heweather.com/cond_icon/201.png\",\r\n202:\"http://files.heweather.com/cond_icon/202.png\",\r\n203:\"http://files.heweather.com/cond_icon/203.png\",\r\n204:\"http://files.heweather.com/cond_icon/204.png\",\r\n205:\"http://files.heweather.com/cond_icon/205.png\",\r\n206:\"http://files.heweather.com/cond_icon/206.png\",\r\n207:\"http://files.heweather.com/cond_icon/207.png\",\r\n208:\"http://files.heweather.com/cond_icon/208.png\",\r\n209:\"http://files.heweather.com/cond_icon/209.png\",\r\n210:\"http://files.heweather.com/cond_icon/210.png\",\r\n211:\"http://files.heweather.com/cond_icon/211.png\",\r\n212:\"http://files.heweather.com/cond_icon/212.png\",\r\n213:\"http://files.heweather.com/cond_icon/213.png\",\r\n300:\"http://files.heweather.com/cond_icon/300.png\",\r\n301:\"http://files.heweather.com/cond_icon/301.png\",\r\n302:\"http://files.heweather.com/cond_icon/302.png\",\r\n303:\"http://files.heweather.com/cond_icon/303.png\",\r\n304:\"http://files.heweather.com/cond_icon/304.png\",\r\n305:\"http://files.heweather.com/cond_icon/305.png\",\r\n306:\"http://files.heweather.com/cond_icon/306.png\",\r\n307:\"http://files.heweather.com/cond_icon/307.png\",\r\n308:\"http://files.heweather.com/cond_icon/308.png\",\r\n309:\"http://files.heweather.com/cond_icon/309.png\",\r\n310:\"http://files.heweather.com/cond_icon/310.png\",\r\n311:\"http://files.heweather.com/cond_icon/311.png\",\r\n312:\"http://files.heweather.com/cond_icon/312.png\",\r\n313:\"http://files.heweather.com/cond_icon/313.png\",\r\n400:\"http://files.heweather.com/cond_icon/400.png\",\r\n401:\"http://files.heweather.com/cond_icon/401.png\",\r\n402:\"http://files.heweather.com/cond_icon/402.png\",\r\n403:\"http://files.heweather.com/cond_icon/403.png\",\r\n404:\"http://files.heweather.com/cond_icon/404.png\",\r\n405:\"http://files.heweather.com/cond_icon/405.png\",\r\n406:\"http://files.heweather.com/cond_icon/406.png\",\r\n407:\"http://files.heweather.com/cond_icon/407.png\",\r\n500:\"http://files.heweather.com/cond_icon/500.png\",\r\n501:\"http://files.heweather.com/cond_icon/501.png\",\r\n502:\"http://files.heweather.com/cond_icon/502.png\",\r\n503:\"http://files.heweather.com/cond_icon/503.png\",\r\n504:\"http://files.heweather.com/cond_icon/504.png\",\r\n506:\"http://files.heweather.com/cond_icon/506.png\",\r\n507:\"http://files.heweather.com/cond_icon/507.png\",\r\n508:\"http://files.heweather.com/cond_icon/508.png\",\r\n900:\"http://files.heweather.com/cond_icon/900.png\",\r\n901:\"http://files.heweather.com/cond_icon/901.png\",\r\n999:\"http://files.heweather.com/cond_icon/999.png\"\r\n}\r\n```\r\nshowWeather()函数构建DOM;\r\n\r\n```\r\nfunction showWeather(city,result) { \r\n    var daily = result.daily_forecast;\r\n    var now = result.now;\r\n    var dailyDom='';\r\n    for(var i=0;i<daily.length;i++){\r\n        var day = daily[i];\r\n         dailyDom += '<div class=\"row\">'\r\n            +'<h4>'+day.date+'</h4>'\r\n            +'<img src=\"'+cond_info[day.cond.code_d]+'\" />'\r\n            +'<h1>'+day.tmp.min+'~'+day.tmp.max+'</h1>'\r\n            +'<h4>'+day.cond.txt_d+'</h4>'     \r\n        +'</div>'       \r\n    }\r\n    var today = '<h1 class=\"city\">'+city+'</h1>'\r\n                +'<div class=\"row_detail\">'\r\n                    +'<img src=\"'+cond_info[now.cond.code]+'\" />'\r\n                    +'<h1>'+now.tmp+'<span>℃</span></h1>'            \r\n                +'</div>'\r\n                +'<div class=\"wind\">'\r\n                    +'<h2>'+now.cond.txt+'</h2>'\r\n                    +'<h4>风速 '+now.wind.spd+'   湿度 '+now.hum+'%</h4>'            \r\n                +'</div>'\r\n    \r\n    document.getElementById('today').innerHTML = today;\r\n    document.getElementById('wrap').innerHTML = dailyDom; \r\n}\r\n```\r\n\r\n这时，再点击weather图标，天气扩展基本上就完成了，不过因为和风API有请求次数限制，也为了减少请求，这里做一下数据缓存。\r\n```\r\nvar _time = new Date().getTime()-(60*60*1000*2); //接口次数有限，两小时请求一次\r\nvar storageTime = localStorage.updateTime||0;\r\n\r\nhttpRequest('http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=json',function(data) {\r\n    if(!data) return;\r\n    data = JSON.parse(data);\r\n    var city = data.city;\r\n    var url = 'https://api.heweather.com/x3/weather?city='+city+'&key=youkey';\r\n    if(_time>storageTime){\r\n        httpRequest(url,function(data) {\r\n            data = JSON.parse(data);\r\n            var result = data[\"HeWeather data service 3.0\"][0];        \r\n            showWeather(city,result);\r\n            localStorage.updateTime = new Date().getTime();  \r\n            localStorage.data = JSON.stringify(result);    \r\n        });\r\n    }else{\r\n        var result = JSON.parse(localStorage.data);\r\n        showWeather(city,result);\r\n    }\r\n\r\n});\r\n```\r\n\r\n至此，一个简单的chrome天气扩展就完成了，是不是比想象中更简单。\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}